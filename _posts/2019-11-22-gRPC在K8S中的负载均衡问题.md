gRPC客户端创建的Channel内部会包含1个或多个subchannel，这些subchannel是实际的HTTP2连接。实际使用中发现，如果headless service的endpoint被删除重建，会出现连不上的情况“Deadline exceeded”。这篇文章是对负载均衡领域以及gRPC特有的负载均衡相关问题的整理。

## 负载均衡领域常见问题

负载均衡的基本定义：通过全局唯一的域名/IP将网络流量分发到多个后台服务。

几个问题：

- 分发由谁来完成？客户端？第三方服务？
- 在网络栈的哪一层做分发？

### Proxy LB

优点：

- 客户端实现简单
- 不要求客户端必须是授信过的

缺点：

- 时延更高，吞吐可能更低，进而可能影响扩展性

### 客户端LB

优点：

- 高性能，因为数据通道中没有额外的一跳

缺点：

- 客户端实现复杂

### Lookaside LB

优点：

- 简化客户端实现
- 不影响数据通路

缺点：

- 客户端需要发送额外的请求以获取可访问的server；
- server与客户端之间没有隔离，这意味着相比proxy lb下，server需要更多的安全保障。

## 网络栈(L4 vs L7)

### L4

优点：

- 不需要对数据包做太多解析，时延更低

缺点：

- 无法感知更高层协议栈包含的信息，丰富负载均衡的配置

### L7

优点：

- 便于根据应用层内容作出决策
  - 比如使用cookie用来定位特定的资源

缺点：

- 解析带来更高的时延

## gRPC客户端负载均衡的问题

gRPC是一个基于HTTP/2的协议，HTTP/2会复用长连接.gRPC内部实现中，除非所有的长连接都断开了，比如当所有的目标服务器都重启，才会重新进行DNS解析，这意味着gRPC不能及时发现新的服务。

那么有哪些办法可以让客户端负载均衡能够自动发现新的服务呢？

gRPC建议方案：设置Channel最大存活时间，这个时间是底层长连接的存活时间，当所有的连接都断开之后，就会触发重新DNS解析发现新的服务。

## 参考

https://grpc.io/blog/loadbalancing/

grpc域名解析与负载均衡的讨论：https://github.com/grpc/grpc/issues/12295
